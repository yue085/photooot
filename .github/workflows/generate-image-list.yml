name: Generate Image List

on:
  push:
    branches: [ main, master ] # 监听 main 或 master 分支的推送
  workflow_dispatch: # 允许你在网页上手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 给机器人写入文件的权限

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan images folder
        id: scan
        run: |
          # 定义支持的图片格式
          EXTENSIONS=("jpg" "jpeg" "png" "gif" "webp" "svg")
          
          # 构建 JSON 数组
          echo "[" > images.json
          FIRST_FILE=true
          
          # 遍历 images 文件夹
          if [ -d "images" ]; then
            for file in images/*; do
              if [ -f "$file" ]; then
                EXT="${file##*.}"
                EXT_LOWER=$(echo "$EXT" | tr '[:upper:]' '[:lower:]')
                
                # 检查是否为支持的格式
                if [[ " ${EXTENSIONS[@]} " =~ " ${EXT_LOWER} " ]]; then
                  if [ "$FIRST_FILE" = true ]; then
                    FIRST_FILE=false
                  else
                    echo "," >> images.json
                  fi
                  # 写入文件路径，注意转义
                  echo "  \"$file\"" >> images.json
                fi
              fi
            done
          fi
          
          echo "]" >> images.json
          
          # 显示结果以便调试
          cat images.json

      - name: Commit and push if needed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images.json
          # 只有当 images.json 有变化时才提交
          git diff --quiet && git diff --staged --quiet || (git commit -m "自动更新图片列表" && git push)
